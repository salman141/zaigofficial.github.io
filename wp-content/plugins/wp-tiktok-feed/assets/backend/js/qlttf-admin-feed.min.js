
(function(f){var l=0,a;var e=function(m){return m.is(".processing")||m.parents(".processing").length};var d=function(){f("#qlttf_modal").addClass("processing")};var j=function(){f("#qlttf_modal").removeClass("processing")};_.mixin({escapeHtml:function(m){return m.replace("&amp;",/&/g).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&#039;/g,"'")},getFormData:function(m){return m.serializeJSON({checkboxUncheckedValue:"false",parseBooleans:true,parseNulls:true})}});var b=Backbone.Model.extend({defaults:qlttf_feed.args});var g=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("qlttf-modal-tabs")},render:function(){this.model.attributes.panel="tab_panel_feed";this.$el.html(this.templates.window(this.model.attributes))}});var i=Backbone.View.extend({templates:{},initialize:function(){this.templates.window=wp.template("qlttf-modal-panels")},render:function(){this.$el.html(this.templates.window(this.model.attributes));this.$el.trigger("qlttf-enhanced-color")}});var h=Backbone.View.extend({events:{"change input":"enable","change textarea":"enable","change select":"enable","click .media-modal-image":"setLayout","click .media-modal-backdrop":"close","click .media-modal-close":"close","click .media-modal-prev":"edit","click .media-modal-next":"edit","click .media-modal-tab":"tab","change .media-modal-render-tabs":"renderTabs","change .media-modal-render-panels":"renderPanels","submit .media-modal-form":"submit","qlttf.color.change input":"enable",},templates:{},initialize:function(){_.bindAll(this,"open","tab","edit","change","load","render","close","submit");this.init();this.open()},init:function(){this.templates.window=wp.template("qlttf-modal-main")},assign:function(n,m){n.setElement(this.$(m)).render()},render:function(){var m=this;m.$el.html(m.templates.window(m.model.attributes));this.tabs=new g({model:m.model});this.panels=new i({model:m.model});this.assign(this.tabs,"#qlttf-modal-tabs");this.assign(this.panels,"#qlttf-modal-panels");_.delay(function(){m.$el.trigger("qlttf-enhanced-color")},100)},load:function(){var n=this,m=n.$el.find("#qlttf_modal");if(n.model.attributes.id==undefined){n.render();return}f.ajax({url:ajaxurl,data:{action:"qlttf_edit_feed",nonce:qlttf_feed.nonce.qlttf_edit_feed,feed_id:this.model.attributes.id},dataType:"json",type:"POST",beforeSend:function(){},complete:function(){j()},error:function(){alert("Error!")},success:function(o){if(o.success){n.model.set(o.data);n.render()}else{alert(o.data)}}})},edit:function(q){q.preventDefault();var n=this,p=f(q.target),o=parseInt(f("#qlttf_feeds_table tr[data-feed_id]").length),m=parseInt(n.model.get("order"));l++;if(a){clearTimeout(a)}a=setTimeout(function(){if(p.hasClass("media-modal-next")){m=Math.min(m+l,o)}else{m=Math.max(m-l,1)}n.model.set({id:parseInt(f("#qlttf_feeds_table tr[data-feed_position="+m+"]").data("feed_id"))});l=0;n.load()},300)},open:function(n){var m=this;f("body").addClass("modal-open").append(this.$el);if(m.model.attributes.id==undefined){_.delay(function(){j();m.setUsername()},100);return}this.load()},setLayout:function(m){m.preventDefault();m.stopPropagation();f(m.target).find("input[type=radio]").prop("checked",true);f(m.target).siblings().find("input[type=radio]").prop("checked",false);this.updateModel(m);this.renderPanels(m);this.renderTabs(m);this.enable(m)},setUsername:function(o){var n=this,m=n.$el.find("#qlttf_modal").find("form").find("select[name=username]");m.trigger("change")},updateModel:function(p){p.preventDefault();var o=this,m=o.$el.find("#qlttf_modal").find("form");var n=_.getFormData(m);this.model.set(n)},tab:function(r){r.preventDefault();var p=this,o=p.$el.find("#qlttf_modal"),q=f(r.currentTarget),m=o.find("ul.qlttf-tabs"),n=q.find("a").attr("href").replace("#","");m.find(".active").removeClass("active");q.addClass("active");this.model.attributes.panel=n;this.model.changed.panel=n;this.renderPanels(r)},renderTabs:function(m){this.renderPanels(m);this.tabs.render()},renderPanels:function(m){this.updateModel(m);this.panels.render()},change:function(m){m.preventDefault();this.updateModel(m)},reload:function(m){if(this.$el.find("#qlttf_modal").hasClass("reload")){location.reload();return}this.remove();return},close:function(m){m.preventDefault();this.undelegateEvents();f(document).off("focusin");f("body").removeClass("modal-open");this.$el.find("#qlttf_modal").addClass("reload");this.reload(m);return},enable:function(m){f(".media-modal-submit").removeProp("disabled");this.updateModel(m)},submit:function(q){q.preventDefault();var p=this,n=p.$el.find("#qlttf_modal"),o=n.find(".settings-save-status .spinner"),m=n.find(".settings-save-status .saved");f.ajax({url:ajaxurl,data:{action:"qlttf_save_feed",nonce:qlttf_feed.nonce.qlttf_save_feed,feed:JSON.stringify(p.model.attributes)},dataType:"json",type:"POST",beforeSend:function(){f(".media-modal-submit").prop("disabled",true);o.addClass("is-active")},complete:function(){m.addClass("is-active");o.removeClass("is-active");_.delay(function(){m.removeClass("is-active")},1000)},error:function(r){alert("Error!")},success:function(r){console.log(r);if(r.success){if(p.model.attributes.id==undefined){n.addClass("reload");p.reload(q);p.close(q)}}else{alert(r.data)}}});return false}});var c=Backbone.View.extend({initialize:function(p){var o=f(p.target),n=o.closest("[data-feed_position]").data("feed_id");var m=new b();m.set({id:n});new h({model:m}).render()}});f(document).on("qlttf-enhanced-color",function(m){f(".color-picker").filter(":not(.enhanced)").each(function(){if(f(this).is("[readonly]")){f(this).parent(".form-field").addClass("disabled-field")}f(this).wpColorPicker({change:function(n,o){console.log("wpColorPicker");f(n.target).trigger("qlttf.color.change")},clear:function(n,o){},hide:function(n,o){aler("!!!!")}})})});f("#qlttf-add-feed").on("click",function(m){m.preventDefault();new c(m)});var k=false;f(".qlttf_edit_feed").on("click",function(m){m.preventDefault();if(!k){new c(m);k=true}});f(".qlttf_delete_feed").on("click",function(p){p.preventDefault();var q=confirm(qlttf_feed.message.confirm_delete);if(!q){return false}var o=f(p.target),n=o.parent().find(".spinner"),m=o.closest("[data-feed_id]").data("feed_id");f.ajax({url:ajaxurl,data:{action:"qlttf_delete_feed",nonce:qlttf_feed.nonce.qlttf_delete_feed,feed_id:m},dataType:"json",type:"POST",beforeSend:function(){n.addClass("is-active")},complete:function(){n.removeClass("is-active")},error:function(r){},success:function(r){if(r.data){console.log(r.data);location.reload()}else{alert(r.data)}}})});f(".qlttf_clear_cache").on("click",function(p){p.preventDefault();var q=confirm(qlttf_feed.message.confirm_clear_cache);if(!q){return false}var o=f(p.target),n=o.parent().find(".spinner"),m=o.closest("[data-feed_id]").data("feed_id");f.ajax({url:ajaxurl,type:"post",data:{action:"qlttf_clear_cache",feed_id:m,nonce:qlttf_feed.nonce.qlttf_clear_cache,},beforeSend:function(){n.addClass("is-active")},success:function(r){if(r.success){setTimeout(function(){n.removeClass("is-active")},300)}else{alert(r.data)}},complete:function(){setTimeout(function(){n.removeClass("is-active")},600)},error:function(r,s){console.log(s)},})});f(document).on("click","[data-qlttf-copy-feed-shortcode]",function(m){m.preventDefault();f(f(this).data("qlttf-copy-feed-shortcode")).select();document.execCommand("copy")})})(jQuery);